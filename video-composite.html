<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shapeless Room Composite</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #000;
        }

        .video-container {
            position: relative;
            width: 100%;
            height: 100%;
        }

        .video-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
            transition: opacity 0.3s ease;
        }

        /* Initialize button overlay */
        .init-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: center;
            background: rgba(0, 0, 0, 0.85);
        }

        .init-overlay.hidden {
            display: none;
        }

        .init-button {
            padding: 24px 48px;
            font-size: 24px;
            font-weight: bold;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            text-transform: uppercase;
            letter-spacing: 4px;
            color: #fff;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 4px 30px rgba(102, 126, 234, 0.5);
            transition: all 0.3s ease;
        }

        .init-button:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 40px rgba(102, 126, 234, 0.7);
        }

        .init-button:active {
            transform: scale(0.98);
        }

        /* Director Panel */
        .director-panel {
            position: fixed;
            top: 0;
            right: -420px;
            width: 400px;
            height: 100%;
            z-index: 200;
            background: rgba(20, 20, 30, 0.95);
            border-left: 2px solid #667eea;
            padding: 20px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #fff;
            overflow-y: auto;
            transition: right 0.3s ease;
            box-shadow: -5px 0 30px rgba(0, 0, 0, 0.5);
        }

        .director-panel.visible {
            right: 0;
        }

        .director-panel h2 {
            margin: 0 0 20px 0;
            padding-bottom: 10px;
            border-bottom: 1px solid #444;
            font-size: 18px;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: #667eea;
        }

        .director-panel .section {
            margin-bottom: 20px;
        }

        .director-panel .section h3 {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #888;
            margin-bottom: 10px;
        }

        .director-panel label {
            display: block;
            margin-bottom: 6px;
            font-size: 12px;
        }

        .director-panel input[type="range"] {
            width: 100%;
            margin: 3px 0 10px 0;
            accent-color: #667eea;
        }

        .director-panel select {
            width: 100%;
            padding: 6px;
            background: #2a2a3a;
            border: 1px solid #444;
            color: #fff;
            border-radius: 4px;
            font-size: 12px;
        }

        .director-panel input[type="text"] {
            width: 100%;
            padding: 8px;
            background: #2a2a3a;
            border: 1px solid #444;
            color: #fff;
            border-radius: 4px;
            font-size: 12px;
            margin-bottom: 8px;
        }

        .director-panel .btn {
            padding: 8px 12px;
            font-size: 12px;
            font-weight: 500;
            color: #fff;
            background: #3a3a4a;
            border: 1px solid #555;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .director-panel .btn:hover {
            background: #4a4a5a;
            border-color: #667eea;
        }

        .director-panel .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea;
        }

        .director-panel .btn-sm {
            padding: 4px 8px;
            font-size: 11px;
        }

        .director-panel .btn-danger {
            background: #dc3545;
            border-color: #dc3545;
        }

        .director-panel .btn-row {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }

        .director-panel .btn-row .btn {
            flex: 1;
        }

        .director-panel .shortcut-hint {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            text-align: center;
            font-size: 11px;
            color: #666;
        }

        .director-panel .shortcut-hint kbd {
            background: #333;
            padding: 2px 6px;
            border-radius: 3px;
            border: 1px solid #555;
        }

        .layer-card {
            background: #2a2a3a;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 12px;
            border: 1px solid #444;
        }

        .layer-card.active {
            border-color: #667eea;
        }

        .layer-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .layer-card-header .layer-name {
            font-weight: bold;
            font-size: 13px;
            color: #667eea;
        }

        .layer-card-header .layer-actions {
            display: flex;
            gap: 6px;
        }

        .layer-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .layer-controls .full-width {
            grid-column: 1 / -1;
        }

        .layer-controls label {
            font-size: 11px;
            color: #888;
            margin-bottom: 2px;
        }

        .layer-controls input[type="range"] {
            margin: 0;
        }

        .toggle-btn {
            padding: 4px 8px;
            font-size: 10px;
            border-radius: 3px;
            cursor: pointer;
            border: 1px solid #555;
            background: #3a3a4a;
            color: #fff;
        }

        .toggle-btn.active {
            background: #667eea;
            border-color: #667eea;
        }

        .participants-list {
            max-height: 150px;
            overflow-y: auto;
            background: #1a1a2a;
            border-radius: 4px;
            padding: 8px;
            margin-bottom: 10px;
        }

        .participant-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 8px;
            margin-bottom: 4px;
            background: #2a2a3a;
            border-radius: 4px;
            font-size: 12px;
        }

        .participant-item:last-child {
            margin-bottom: 0;
        }

        .color-picker-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .color-picker-row input[type="color"] {
            width: 40px;
            height: 26px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .keyboard-shortcuts {
            font-size: 11px;
            line-height: 1.8;
            color: #888;
            padding: 10px;
            background: #1a1a2a;
            border-radius: 4px;
            margin-bottom: 60px;
        }

        .keyboard-shortcuts div {
            display: flex;
            justify-content: space-between;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }

        .section-header:hover h3 {
            color: #aaa;
        }

        .collapse-icon {
            font-size: 10px;
            color: #666;
            transition: transform 0.2s ease;
        }

        .section.collapsed .section-content {
            display: none;
        }

        .section.collapsed .collapse-icon {
            transform: rotate(-90deg);
        }
    </style>
</head>
<body>
    <div class="video-container" id="video-container">
        <!-- Layers will be added dynamically -->

        <!-- Initialize Overlay -->
        <div id="init-overlay" class="init-overlay">
            <button id="init-button" class="init-button">Initialize</button>
        </div>

        <!-- Director Panel -->
        <div id="director-panel" class="director-panel">
            <h2>Director Panel</h2>

            <!-- Quick Actions -->
            <div class="section">
                <div class="section-header">
                    <h3>Quick Actions</h3>
                    <span class="collapse-icon">&#9660;</span>
                </div>
                <div class="section-content">
                    <div class="btn-row">
                        <button class="btn btn-primary" id="btn-fullscreen">Fullscreen</button>
                        <button class="btn" id="btn-sonobus">Sonobus</button>
                    </div>
                    <div class="btn-row">
                        <button class="btn" id="btn-reload-all">Reload All</button>
                        <button class="btn btn-danger" id="btn-reset">Reset</button>
                    </div>
                </div>
            </div>

            <!-- Room Participants -->
            <div class="section">
                <div class="section-header">
                    <h3>Room: shapeless</h3>
                    <span class="collapse-icon">&#9660;</span>
                </div>
                <div class="section-content">
                    <div class="participants-list" id="participants-list">
                        <div class="participant-item">
                            <span>shapeless-kitchen</span>
                            <button class="btn btn-sm btn-primary" onclick="addLayer('shapeless-kitchen')">Add</button>
                        </div>
                        <div class="participant-item">
                            <span>shapeless-guest</span>
                            <button class="btn btn-sm btn-primary" onclick="addLayer('shapeless-guest')">Add</button>
                        </div>
                    </div>
                    <label>Custom Stream ID:</label>
                    <div class="btn-row">
                        <input type="text" id="custom-stream-id" placeholder="stream-id">
                        <button class="btn" onclick="addLayerFromInput()">Add</button>
                    </div>
                </div>
            </div>

            <!-- Active Layers -->
            <div class="section">
                <div class="section-header">
                    <h3>Active Layers</h3>
                    <span class="collapse-icon">&#9660;</span>
                </div>
                <div class="section-content" id="layers-container">
                    <!-- Layer cards will be added here -->
                    <p style="color: #666; font-size: 12px; text-align: center;">No layers added yet</p>
                </div>
            </div>

            <!-- Background -->
            <div class="section">
                <div class="section-header">
                    <h3>Background</h3>
                    <span class="collapse-icon">&#9660;</span>
                </div>
                <div class="section-content">
                    <div class="color-picker-row">
                        <input type="color" id="bg-color" value="#000000">
                        <span id="bg-color-value">#000000</span>
                    </div>
                </div>
            </div>

            <!-- Keyboard Shortcuts -->
            <div class="section">
                <div class="section-header">
                    <h3>Keyboard Shortcuts</h3>
                    <span class="collapse-icon">&#9660;</span>
                </div>
                <div class="section-content">
                    <div class="keyboard-shortcuts">
                        <div><span>Toggle Panel</span><kbd>Ctrl+D</kbd></div>
                        <div><span>Fullscreen</span><kbd>F</kbd></div>
                        <div><span>Reset All</span><kbd>R</kbd></div>
                    </div>
                </div>
            </div>

            <div class="shortcut-hint">
                Press <kbd>Ctrl</kbd> + <kbd>D</kbd> to toggle
            </div>
        </div>
    </div>

    <script>
        const ROOM_NAME = 'shapeless';
        const SONOBUS_URL = 'sonobus://join/shapeless';
        const BLEND_MODES = ['normal', 'screen', 'multiply', 'overlay', 'lighten', 'darken', 'color-dodge', 'color-burn', 'hard-light', 'soft-light', 'difference', 'exclusion', 'hue', 'saturation', 'color', 'luminosity'];

        // State
        let layers = [];
        let layerIdCounter = 0;

        // DOM Elements
        const videoContainer = document.getElementById('video-container');
        const directorPanel = document.getElementById('director-panel');
        const layersContainer = document.getElementById('layers-container');

        // Initialize
        document.getElementById('init-button').addEventListener('click', function() {
            // Add default layers for the room
            addLayer('shapeless-kitchen', 'normal');
            addLayer('shapeless-guest', 'screen');

            // Open Sonobus
            window.open(SONOBUS_URL, '_self');

            // Hide overlay
            document.getElementById('init-overlay').classList.add('hidden');
        });

        // Section collapse
        document.querySelectorAll('.section-header').forEach(header => {
            header.addEventListener('click', function() {
                this.parentElement.classList.toggle('collapsed');
            });
        });

        // Quick actions
        document.getElementById('btn-fullscreen').addEventListener('click', toggleFullscreen);
        document.getElementById('btn-sonobus').addEventListener('click', () => window.open(SONOBUS_URL, '_blank'));
        document.getElementById('btn-reload-all').addEventListener('click', reloadAllLayers);
        document.getElementById('btn-reset').addEventListener('click', resetAll);

        // Background color
        document.getElementById('bg-color').addEventListener('input', function() {
            document.body.style.background = this.value;
            document.getElementById('bg-color-value').textContent = this.value;
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;

            if (e.ctrlKey && e.key === 'd') {
                e.preventDefault();
                directorPanel.classList.toggle('visible');
            } else if (e.key === 'f' || e.key === 'F') {
                toggleFullscreen();
            } else if (e.key === 'r' || e.key === 'R') {
                resetAll();
            }
        });

        // Layer management functions
        function addLayer(streamId, blendMode = 'screen') {
            const layerId = layerIdCounter++;
            const zIndex = layers.length + 1;

            // Create iframe
            const iframe = document.createElement('iframe');
            iframe.id = `layer-${layerId}`;
            iframe.className = 'video-layer';
            iframe.style.zIndex = zIndex;
            iframe.style.mixBlendMode = zIndex === 1 ? 'normal' : blendMode;
            iframe.allow = 'camera;microphone;autoplay;fullscreen';
            iframe.allowFullscreen = true;
            iframe.src = `https://vdo.ninja/?view=${streamId}`;

            // Insert before overlay
            const overlay = document.getElementById('init-overlay');
            videoContainer.insertBefore(iframe, overlay);

            // Add to state
            const layer = {
                id: layerId,
                streamId: streamId,
                element: iframe,
                opacity: 100,
                blendMode: zIndex === 1 ? 'normal' : blendMode,
                visible: true,
                filters: { brightness: 100, contrast: 100, saturation: 100 }
            };
            layers.push(layer);

            // Update UI
            renderLayerCards();

            return layer;
        }

        function addLayerFromInput() {
            const input = document.getElementById('custom-stream-id');
            const streamId = input.value.trim();
            if (streamId) {
                addLayer(streamId);
                input.value = '';
            }
        }

        function removeLayer(layerId) {
            const index = layers.findIndex(l => l.id === layerId);
            if (index !== -1) {
                layers[index].element.remove();
                layers.splice(index, 1);
                updateZIndices();
                renderLayerCards();
            }
        }

        function updateZIndices() {
            layers.forEach((layer, index) => {
                layer.element.style.zIndex = index + 1;
            });
        }

        function moveLayerUp(layerId) {
            const index = layers.findIndex(l => l.id === layerId);
            if (index < layers.length - 1) {
                [layers[index], layers[index + 1]] = [layers[index + 1], layers[index]];
                updateZIndices();
                renderLayerCards();
            }
        }

        function moveLayerDown(layerId) {
            const index = layers.findIndex(l => l.id === layerId);
            if (index > 0) {
                [layers[index], layers[index - 1]] = [layers[index - 1], layers[index]];
                updateZIndices();
                renderLayerCards();
            }
        }

        function updateLayerOpacity(layerId, value) {
            const layer = layers.find(l => l.id === layerId);
            if (layer) {
                layer.opacity = value;
                layer.element.style.opacity = value / 100;
            }
        }

        function updateLayerBlendMode(layerId, mode) {
            const layer = layers.find(l => l.id === layerId);
            if (layer) {
                layer.blendMode = mode;
                layer.element.style.mixBlendMode = mode;
            }
        }

        function toggleLayerVisibility(layerId) {
            const layer = layers.find(l => l.id === layerId);
            if (layer) {
                layer.visible = !layer.visible;
                layer.element.style.visibility = layer.visible ? 'visible' : 'hidden';
                renderLayerCards();
            }
        }

        function updateLayerFilter(layerId, filterName, value) {
            const layer = layers.find(l => l.id === layerId);
            if (layer) {
                layer.filters[filterName] = value;
                applyLayerFilters(layer);
            }
        }

        function applyLayerFilters(layer) {
            const f = layer.filters;
            layer.element.style.filter = `brightness(${f.brightness}%) contrast(${f.contrast}%) saturate(${f.saturation}%)`;
        }

        function reloadLayer(layerId) {
            const layer = layers.find(l => l.id === layerId);
            if (layer) {
                const src = layer.element.src;
                layer.element.src = '';
                setTimeout(() => { layer.element.src = src; }, 100);
            }
        }

        function renderLayerCards() {
            if (layers.length === 0) {
                layersContainer.innerHTML = '<p style="color: #666; font-size: 12px; text-align: center;">No layers added yet</p>';
                return;
            }

            // Render in reverse order (top layer first)
            const reversedLayers = [...layers].reverse();

            layersContainer.innerHTML = reversedLayers.map((layer, displayIndex) => `
                <div class="layer-card ${layer.visible ? 'active' : ''}">
                    <div class="layer-card-header">
                        <span class="layer-name">${layer.streamId}</span>
                        <div class="layer-actions">
                            <button class="toggle-btn ${layer.visible ? 'active' : ''}" onclick="toggleLayerVisibility(${layer.id})">${layer.visible ? 'ON' : 'OFF'}</button>
                            <button class="btn btn-sm" onclick="moveLayerUp(${layer.id})">&#9650;</button>
                            <button class="btn btn-sm" onclick="moveLayerDown(${layer.id})">&#9660;</button>
                            <button class="btn btn-sm btn-danger" onclick="removeLayer(${layer.id})">X</button>
                        </div>
                    </div>
                    <div class="layer-controls">
                        <div class="full-width">
                            <label>Blend Mode</label>
                            <select onchange="updateLayerBlendMode(${layer.id}, this.value)">
                                ${BLEND_MODES.map(mode => `<option value="${mode}" ${layer.blendMode === mode ? 'selected' : ''}>${mode}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label>Opacity: ${layer.opacity}%</label>
                            <input type="range" min="0" max="100" value="${layer.opacity}" oninput="updateLayerOpacity(${layer.id}, this.value); this.previousElementSibling.textContent='Opacity: '+this.value+'%'">
                        </div>
                        <div>
                            <label>Brightness: ${layer.filters.brightness}%</label>
                            <input type="range" min="0" max="200" value="${layer.filters.brightness}" oninput="updateLayerFilter(${layer.id}, 'brightness', this.value); this.previousElementSibling.textContent='Brightness: '+this.value+'%'">
                        </div>
                        <div>
                            <label>Contrast: ${layer.filters.contrast}%</label>
                            <input type="range" min="0" max="200" value="${layer.filters.contrast}" oninput="updateLayerFilter(${layer.id}, 'contrast', this.value); this.previousElementSibling.textContent='Contrast: '+this.value+'%'">
                        </div>
                        <div>
                            <label>Saturation: ${layer.filters.saturation}%</label>
                            <input type="range" min="0" max="200" value="${layer.filters.saturation}" oninput="updateLayerFilter(${layer.id}, 'saturation', this.value); this.previousElementSibling.textContent='Saturation: '+this.value+'%'">
                        </div>
                        <div class="full-width">
                            <button class="btn btn-sm" onclick="reloadLayer(${layer.id})" style="width:100%">Reload Feed</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function reloadAllLayers() {
            layers.forEach(layer => reloadLayer(layer.id));
        }

        function resetAll() {
            // Remove all layers
            layers.forEach(layer => layer.element.remove());
            layers = [];
            layerIdCounter = 0;

            // Reset background
            document.body.style.background = '#000';
            document.getElementById('bg-color').value = '#000000';
            document.getElementById('bg-color-value').textContent = '#000000';

            // Update UI
            renderLayerCards();

            // Show init overlay
            document.getElementById('init-overlay').classList.remove('hidden');
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }
    </script>
</body>
</html>
