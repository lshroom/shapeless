<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shapeless Multi-Camera Composite</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body {
            background: #000;
            font-family: 'Arial', sans-serif;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        .container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }

        .container.composite-mode .video-layer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            border: none;
        }

        .container.grid-mode {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 5px;
            padding: 5px;
        }

        .container.grid-mode .video-layer {
            position: relative;
            width: 100%;
            height: 100%;
            border: 2px solid #667eea;
            border-radius: 8px;
            mix-blend-mode: normal !important;
            opacity: 1 !important;
        }

        .controls {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: rgba(0,0,0,0.95);
            padding: 15px;
            border-radius: 8px;
            color: #fff;
            width: 320px;
            max-height: 95vh;
            overflow-y: auto;
            border: 1px solid #333;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .controls.hidden {
            opacity: 0;
            visibility: hidden;
        }

        .controls::-webkit-scrollbar { width: 8px; }
        .controls::-webkit-scrollbar-track { background: #111; }
        .controls::-webkit-scrollbar-thumb { background: #667eea; border-radius: 4px; }

        .header {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .header h2 {
            font-size: 16px;
            color: #667eea;
            margin-bottom: 10px;
        }

        .hotkeys-info {
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid #667eea;
            border-radius: 6px;
            padding: 8px;
            margin-bottom: 10px;
            font-size: 10px;
            line-height: 1.6;
        }

        .hotkeys-info strong {
            color: #00ffaa;
        }

        .record-section {
            background: rgba(255,0,0,0.1);
            border: 1px solid #ff4444;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 10px;
        }

        .record-section h4 {
            font-size: 11px;
            color: #ff4444;
            margin-bottom: 8px;
            text-transform: uppercase;
        }

        .record-btn {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 12px;
            margin-bottom: 5px;
        }

        .record-btn.start {
            background: #ff4444;
            color: #fff;
        }

        .record-btn.recording {
            background: #ff0000;
            color: #fff;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .record-timer {
            font-size: 14px;
            font-weight: bold;
            text-align: center;
            color: #ff4444;
            margin: 5px 0;
        }

        .record-status {
            font-size: 10px;
            color: #ff4444;
            text-align: center;
            margin-top: 5px;
        }

        .recording-indicator {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255,0,0,0.9);
            color: #fff;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
            z-index: 999;
            display: none;
            animation: pulse 1.5s infinite;
        }

        .recording-indicator.active {
            display: block;
        }

        .view-toggle {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
        }

        .view-btn {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            font-weight: bold;
        }

        .view-btn.active {
            background: #667eea;
            color: #fff;
        }

        .view-btn:not(.active) {
            background: #333;
            color: #999;
        }

        .add-layer-btn {
            width: 100%;
            padding: 8px;
            background: #00ffaa;
            color: #000;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 12px;
            margin-bottom: 10px;
        }

        .layer-card {
            background: rgba(255,255,255,0.05);
            border: 1px solid #333;
            border-radius: 6px;
            margin-bottom: 10px;
            overflow: hidden;
        }

        .layer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: rgba(255,255,255,0.03);
            cursor: pointer;
            user-select: none;
        }

        .layer-title {
            font-size: 13px;
            font-weight: bold;
            color: #667eea;
        }

        .layer-actions {
            display: flex;
            gap: 5px;
        }

        .toggle-btn, .remove-btn, .visibility-btn, .mute-btn, .layer-record-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
            font-weight: bold;
        }

        .toggle-btn { background: #444; color: #fff; }
        .visibility-btn { background: #667eea; color: #fff; }
        .visibility-btn.hidden { background: #333; color: #666; }
        .mute-btn { background: #ff9500; color: #fff; }
        .mute-btn.muted { background: #333; color: #666; }
        .layer-record-btn { background: #ff4444; color: #fff; }
        .layer-record-btn.recording { background: #ff0000; animation: pulse 1.5s infinite; }
        .remove-btn { background: #ff4444; color: #fff; }

        .layer-controls { padding: 10px; display: none; }
        .layer-controls.expanded { display: block; }
        .control-group { margin-bottom: 10px; }

        label {
            display: block;
            margin-bottom: 4px;
            font-size: 11px;
            color: #aaa;
        }

        .value {
            float: right;
            color: #667eea;
            font-weight: bold;
        }

        input[type="range"] { width: 100%; height: 4px; margin-top: 3px; }

        select, input[type="text"] {
            width: 100%;
            padding: 6px;
            background: #222;
            color: #fff;
            border: 1px solid #444;
            border-radius: 3px;
            font-size: 11px;
        }

        button.load-btn {
            width: 100%;
            padding: 6px;
            background: #667eea;
            color: #fff;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            margin-top: 4px;
            font-size: 11px;
        }

        .mode-indicator {
            font-size: 10px;
            color: #00ffaa;
            text-align: center;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container composite-mode" id="video-container"></div>
    <div class="recording-indicator" id="rec-indicator">‚è∫ RECORDING <span id="rec-time">00:00</span></div>

    <div class="controls" id="controls-panel">
        <div class="header">
            <h2>üè¥‚Äç‚ò†Ô∏è Shapeless</h2>

            <div class="hotkeys-info">
                <strong>H</strong> - Hide/Show Controls<br>
                <strong>R</strong> - Start Recording<br>
                <strong>S</strong> - Stop Recording<br>
                <strong>G</strong> - Toggle Grid/Composite
            </div>

            <div class="record-section">
                <h4>üé¨ Composite Recording</h4>
                <button class="record-btn start" id="record-btn" onclick="toggleRecording()">‚è∫ Record (or press R)</button>
                <div class="record-timer" id="record-timer" style="display:none;">00:00</div>
                <div class="record-status" id="record-status">Press H to hide panel!</div>
            </div>

            <div class="view-toggle">
                <button class="view-btn active" onclick="setViewMode('composite')">üé® Composite</button>
                <button class="view-btn" onclick="setViewMode('grid')">üëÅ Grid View</button>
            </div>
            <button class="add-layer-btn" onclick="addLayer()">+ Add Camera</button>
            <div class="mode-indicator" id="mode-indicator">Composite Mode</div>
        </div>
        <div id="layers-list"></div>
    </div>

    <script>
        let layerCount = 0;
        const layers = {};
        let viewMode = 'composite';
        let compositeRecorder = null;
        let recordedChunks = [];
        let isRecordingComposite = false;
        let recordingStartTime = 0;
        let timerInterval = null;
        let controlsVisible = true;

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;
            switch(e.key.toLowerCase()) {
                case 'h': toggleControls(); break;
                case 'r': if (!isRecordingComposite) toggleRecording(); break;
                case 's': if (isRecordingComposite) toggleRecording(); break;
                case 'g': setViewMode(viewMode === 'composite' ? 'grid' : 'composite'); break;
            }
        });

        function toggleControls() {
            controlsVisible = !controlsVisible;
            document.getElementById('controls-panel').classList.toggle('hidden');
        }

        function setViewMode(mode) {
            viewMode = mode;
            const container = document.getElementById('video-container');
            const buttons = document.querySelectorAll('.view-btn');

            if (mode === 'composite') {
                container.className = 'container composite-mode';
                buttons[0].classList.add('active');
                buttons[1].classList.remove('active');
            } else {
                container.className = 'container grid-mode';
                buttons[0].classList.remove('active');
                buttons[1].classList.add('active');
            }
        }

        async function toggleRecording() {
            if (!isRecordingComposite) await startRecording();
            else stopRecording();
        }

        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getDisplayMedia({
                    video: { width: 1920, height: 1080, frameRate: 30 },
                    audio: true
                });

                recordedChunks = [];
                compositeRecorder = new MediaRecorder(stream, {
                    mimeType: 'video/webm;codecs=vp9'
                });

                compositeRecorder.ondataavailable = (e) => {
                    if (e.data.size > 0) recordedChunks.push(e.data);
                };

                compositeRecorder.onstop = () => {
                    const blob = new Blob(recordedChunks, { type: 'video/webm' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `shapeless-${Date.now()}.webm`;
                    a.click();
                    URL.revokeObjectURL(url);
                    stream.getTracks().forEach(t => t.stop());
                };

                compositeRecorder.start();
                isRecordingComposite = true;
                recordingStartTime = Date.now();

                document.getElementById('record-btn').textContent = '‚èπ Stop (or press S)';
                document.getElementById('record-btn').className = 'record-btn recording';
                document.getElementById('record-status').textContent = 'Recording...';
                document.getElementById('record-timer').style.display = 'block';
                document.getElementById('rec-indicator').classList.add('active');

                timerInterval = setInterval(updateTimer, 1000);
            } catch (err) {
                alert('Recording cancelled. Press H to hide controls, then try again.');
            }
        }

        function stopRecording() {
            if (compositeRecorder) {
                compositeRecorder.stop();
                isRecordingComposite = false;

                document.getElementById('record-btn').textContent = '‚è∫ Record (or press R)';
                document.getElementById('record-btn').className = 'record-btn start';
                document.getElementById('record-status').textContent = 'Saved to Downloads!';
                document.getElementById('record-timer').style.display = 'none';
                document.getElementById('rec-indicator').classList.remove('active');
                clearInterval(timerInterval);

                setTimeout(() => {
                    document.getElementById('record-status').textContent = 'Press H to hide panel!';
                }, 3000);
            }
        }

        function updateTimer() {
            const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
            const min = Math.floor(elapsed / 60).toString().padStart(2, '0');
            const sec = (elapsed % 60).toString().padStart(2, '0');
            const time = `${min}:${sec}`;
            document.getElementById('record-timer').textContent = time;
            document.getElementById('rec-time').textContent = time;
        }

        async function toggleLayerRecording(layerId, layerNum) {
            const layer = layers[layerId];
            const btn = document.querySelector(`#record-${layerId}`);

            if (!layer.isRecording) {
                try {
                    const stream = await navigator.mediaDevices.getDisplayMedia({
                        video: true,
                        audio: true
                    });

                    layer.layerRecorder = new MediaRecorder(stream, {
                        mimeType: 'video/webm;codecs=vp9'
                    });

                    layer.recordedChunks = [];

                    layer.layerRecorder.ondataavailable = (e) => {
                        if (e.data.size > 0) layer.recordedChunks.push(e.data);
                    };

                    layer.layerRecorder.onstop = () => {
                        const blob = new Blob(layer.recordedChunks, { type: 'video/webm' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `shapeless-camera${layerNum}-${Date.now()}.webm`;
                        a.click();
                        URL.revokeObjectURL(url);
                        stream.getTracks().forEach(t => t.stop());
                    };

                    layer.layerRecorder.start();
                    layer.isRecording = true;
                    btn.textContent = '‚èπ';
                    btn.classList.add('recording');
                } catch (err) {
                    alert('Layer recording failed!');
                }
            } else {
                if (layer.layerRecorder) {
                    layer.layerRecorder.stop();
                    layer.isRecording = false;
                    btn.textContent = '‚è∫';
                    btn.classList.remove('recording');
                }
            }
        }

        function addLayer() {
            layerCount++;
            const layerId = `layer${layerCount}`;

            const iframe = document.createElement('iframe');
            iframe.id = layerId;
            iframe.className = 'video-layer';
            iframe.style.zIndex = layerCount;
            iframe.style.opacity = '1';
            iframe.style.mixBlendMode = layerCount === 1 ? 'normal' : 'screen';
            iframe.setAttribute('allow', 'camera;microphone;autoplay;display-capture');
            document.getElementById('video-container').appendChild(iframe);

            layers[layerId] = {
                iframe,
                visible: true,
                muted: false,
                opacity: 100,
                blend: layerCount === 1 ? 'normal' : 'screen',
                isRecording: false,
                layerRecorder: null,
                recordedChunks: []
            };

            createLayerControls(layerId, layerCount);
        }

        function createLayerControls(layerId, layerNum) {
            const card = document.createElement('div');
            card.className = 'layer-card';
            card.id = `card-${layerId}`;
            card.innerHTML = `
                <div class="layer-header" onclick="toggleLayer('${layerId}')">
                    <span class="layer-title">Camera ${layerNum}</span>
                    <div class="layer-actions" onclick="event.stopPropagation()">
                        <button class="layer-record-btn" id="record-${layerId}" onclick="toggleLayerRecording('${layerId}', ${layerNum})" title="Record This Layer">‚è∫</button>
                        <button class="visibility-btn" onclick="toggleVisibility('${layerId}')">üëÅ</button>
                        <button class="mute-btn" onclick="toggleMute('${layerId}')">üîä</button>
                        <button class="toggle-btn">‚ñº</button>
                        <button class="remove-btn" onclick="removeLayer('${layerId}')">√ó</button>
                    </div>
                </div>
                <div class="layer-controls" id="controls-${layerId}">
                    <div class="control-group">
                        <label>VDO.ninja URL</label>
                        <input type="text" id="url-${layerId}" placeholder="https://vdo.ninja/?view=...">
                        <button class="load-btn" onclick="loadLayerUrl('${layerId}')">Load Stream</button>
                    </div>
                    <div class="control-group">
                        <label>Opacity <span class="value" id="opacity-val-${layerId}">100%</span></label>
                        <input type="range" id="opacity-${layerId}" min="0" max="100" value="100" oninput="updateOpacity('${layerId}', this.value)">
                    </div>
                    <div class="control-group">
                        <label>Blend Mode</label>
                        <select id="blend-${layerId}" onchange="updateBlend('${layerId}', this.value)">
                            <option value="normal" ${layerNum === 1 ? 'selected' : ''}>Normal</option>
                            <option value="screen" ${layerNum > 1 ? 'selected' : ''}>Screen</option>
                            <option value="multiply">Multiply</option>
                            <option value="overlay">Overlay</option>
                            <option value="lighten">Lighten</option>
                            <option value="darken">Darken</option>
                            <option value="difference">Difference</option>
                            <option value="color-dodge">Color Dodge</option>
                            <option value="hard-light">Hard Light</option>
                            <option value="soft-light">Soft Light</option>
                        </select>
                    </div>
                </div>
            `;
            document.getElementById('layers-list').appendChild(card);
        }

        function toggleLayer(layerId) {
            const controls = document.getElementById(`controls-${layerId}`);
            const btn = document.querySelector(`#card-${layerId} .toggle-btn`);
            if (controls.classList.contains('expanded')) {
                controls.classList.remove('expanded');
                btn.textContent = '‚ñº';
            } else {
                controls.classList.add('expanded');
                btn.textContent = '‚ñ≤';
            }
        }

        function toggleVisibility(layerId) {
            const layer = layers[layerId];
            layer.visible = !layer.visible;
            layer.iframe.style.display = layer.visible ? 'block' : 'none';
            const btn = document.querySelector(`#card-${layerId} .visibility-btn`);
            btn.textContent = layer.visible ? 'üëÅ' : 'üëÅ‚Äçüó®';
            btn.classList.toggle('hidden');
        }

        function toggleMute(layerId) {
            const layer = layers[layerId];
            layer.muted = !layer.muted;
            const btn = document.querySelector(`#card-${layerId} .mute-btn`);
            btn.textContent = layer.muted ? 'üîá' : 'üîä';
            btn.classList.toggle('muted');
        }

        function removeLayer(layerId) {
            if (confirm('Remove this camera?')) {
                layers[layerId].iframe.remove();
                document.getElementById(`card-${layerId}`).remove();
                delete layers[layerId];
            }
        }

        function loadLayerUrl(layerId) {
            const url = document.getElementById(`url-${layerId}`).value;
            if (url) layers[layerId].iframe.src = url;
        }

        function updateOpacity(layerId, value) {
            layers[layerId].iframe.style.opacity = value / 100;
            document.getElementById(`opacity-val-${layerId}`).textContent = value + '%';
        }

        function updateBlend(layerId, mode) {
            layers[layerId].iframe.style.mixBlendMode = mode;
        }

        // Start with 2 layers
        addLayer();
        addLayer();
        document.getElementById('controls-layer1').classList.add('expanded');
        document.querySelector('#card-layer1 .toggle-btn').textContent = '‚ñ≤';
    </script>
</body>
</html>
